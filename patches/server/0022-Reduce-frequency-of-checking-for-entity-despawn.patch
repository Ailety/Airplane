From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Paul Sauve <paul@technove.co>
Date: Mon, 26 Apr 2021 11:20:12 -0500
Subject: [PATCH] Reduce frequency of checking for entity despawn

This isn't a great way to deal with this, but at a high number of
entities this starts adding up more than it should, and it's already
fairly optimized. Just starts being slow when you have 30k entities.

diff --git a/src/main/java/gg/airplane/AirplaneConfig.java b/src/main/java/gg/airplane/AirplaneConfig.java
index ac49dc0c8bce07954ab69a18f0ee1f0b7d0db749..57f737e7a48366c597a73356c076d3ff95850b12 100644
--- a/src/main/java/gg/airplane/AirplaneConfig.java
+++ b/src/main/java/gg/airplane/AirplaneConfig.java
@@ -109,4 +109,13 @@ public class AirplaneConfig {
     }
 
 
+    public static byte entityDespawnCheckFrequency;
+
+    private static void entitySettings() {
+        config.setComment("entities", "Configures settings for generic entities");
+
+        entityDespawnCheckFrequency = (byte) Math.max(config.getInt("entities.despawn-check-freq", 8), Byte.MAX_VALUE);
+    }
+
+
 }
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index 287e588ede2b6df6053f551dae930a49d2de9c88..c4d1e8d1319b20abbaff1d0ddce5207dc654ad9f 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -779,8 +779,15 @@ public abstract class Mob extends LivingEntity {
         return false;
     }
 
+    // Airplane start - just reduce frequency of checking for despawn
+    private byte despawnCheck = 0;
     @Override
     public void checkDespawn() {
+        if (++despawnCheck < gg.airplane.AirplaneConfig.entityDespawnCheckFrequency) {
+            return;
+        }
+        this.despawnCheck = 0;
+        // Airplane end
         if (this.level.getDifficulty() == Difficulty.PEACEFUL && this.shouldDespawnInPeaceful()) {
             this.discard();
         } else if (!this.isPersistenceRequired() && !this.requiresCustomPersistence()) {
